#!/bin/bash
# the-house
# main entry point
# Copyright (c) 2025 therock
# SPDX-License-Identifier: MIT

set -euo pipefail
BALANCE_FILE="$HOME/.config/the-house/balance.txt"
BLACKLIST_FILE="$HOME/.config/the-house/blacklist.txt"
LOG_FILE="$HOME/.config/the-house/log.txt"
PACT_FILE="$HOME/.config/the-house/pact.txt"
mkdir -p "$HOME/.config/the-house"
touch "$BALANCE_FILE" "$LOG_FILE"

if [[ ! -s "$BALANCE_FILE" ]]; then
    echo 500 > "$BALANCE_FILE" # starting balance, graceful (be glad)
fi

VERSION="1.0.2-4"
if [[ "${1-}" == "--version" || "${1-}" == "-v" ]]; then
    echo "the-house $VERSION"
    exit 0
fi

if [[ "${1-}" == "--redeem-my-soul" ]]; then
    if [[ ! -f "$BLACKLIST_FILE" ]]; then
        echo "you are not blacklisted... yet."
        exit 0
    fi

    echo "redemption arc"
    rm -f "$BLACKLIST_FILE"
    echo "you may return to the house"
    echo 100 > "$BALANCE_FILE"
    exit 0
fi


player_money=$(<"$BALANCE_FILE")
if [[ "$player_money" -eq 0 ]]; then
    echo "you've gone broke. the house does not tolerate weakness."
    echo "use: the-house --redeem-my-soul"
    echo "blacklisted for going broke" > "$BLACKLIST_FILE"
    exit 1
fi

if [[ "$player_money" -gt 1000000 ]]; then
    echo "did you cheat?"
    echo "doesnt matter now, you won i guess"
    echo "final balance: $player_money"
    exit 0
fi

if [[ "${1-}" == "--help" || "${1-}" == "-h" ]]; then
    cat <<EOF
the-house $VERSION

usage: the-house [--version|--help|--redeem-my-soul]

options:
  --version, -v           show version
  --help, -h              show this help
  --redeem-my-soul        reset after blacklisting and set balance to 100$

gamble wisely. the house always wins.
EOF
    exit 0
fi

if [[ -f "$BLACKLIST_FILE" ]]; then
    echo "the house remembers."
    echo "you are not welcome here."
    echo
    echo "use: the-house --redeem-my-soul"
    exit 1
fi

while true; do
    clear
    echo "welcome to the house"
    echo "your balance: \$$player_money"
    if [[ -f "$PACT_FILE" ]]; then
    echo "it looks like youve signed the pact, interesting"
    sleep 0.5
    fi
    echo
    sleep 1
    echo "choose your sin:"
    echo "1) blackjack"
    echo "2) russian roulette"
    echo "3) dice duel"
    echo "4) coin flip"
    echo "5) the pact"
    echo "6) exit"
    echo

    read -r -p "select an option: " choice
    case "$choice" in
        1)
            bash /usr/lib/the-house/games/blackjack.sh
            player_money=$(<"$BALANCE_FILE")
            [[ -f "$BLACKLIST_FILE" ]] && break
            ;;
        2)
            bash /usr/lib//the-house/games/russian-roulette.sh
            player_money=$(<"$BALANCE_FILE")
            [[ -f "$BLACKLIST_FILE" ]] && break
            ;;
        3)
            bash /usr/lib/the-house/games/dice-duel.sh
            player_money=$(<"$BALANCE_FILE")
            [[ -f "$BLACKLIST_FILE" ]] && break
            ;;
        4)
            bash /usr/lib/the-house/games/coinflip.sh
            player_money=$(<"$BALANCE_FILE")
            [[ -f "$BLACKLIST_FILE" ]] && break
            ;;
        5)
            bash /usr/lib/the-house/games/pact.sh
            player_money=$(<"$BALANCE_FILE")
            [[ -f "$BLACKLIST_FILE" ]] && break
            ;;
        6)
            echo "the house always wins."
            exit 0
            ;;
        *)
            echo "invalid selection."
            sleep 1
            ;;
    esac
done
